<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<head>
    <title>Eternalæ–‡ä»¶æµè§ˆå™¨</title>
    <link rel="stylesheet" href="styles.css">

</head>
<body>
<div id="login-box" class="login-box">
    <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
    <input type="password" id="password" placeholder="å¯†ç " onkeyup="handleEnter(event)">
    <button onclick="verifyPassword()">ç™»å½•</button>
    <p id="error-msg" style="color:red;"></p>
</div>

<div id="file-browser">
    <h1>Chungæ–‡ä»¶æµè§ˆå™¨</h1>
    <div class="breadcrumb" id="path-nav"></div>
    <button onclick="goBack()">è¿”å›ä¸Šçº§ç›®å½•</button>
    <div id="file-list"></div>
</div>
<div id="DivAccessLog">
    <a href="admin_logs.php" class="admin-link">æŸ¥çœ‹è®¿é—®æ—¥å¿—</a>
</div>


<div id="overlay">
    <div class="popup">
        <p class="popup_title">å‹ç¼©è¿›åº¦</p>
        <p class="popup_content">
        <progress  id="progressBar" value="0" max="100"></progress>
        <span id="progressValue">0.00%</span>
        </p>
        <!--        <p class="popup_content">å­¦ä¼šåˆ¶ä½œå¼¹å‡ºæ¡†äº†å—ï¼Ÿ</p>-->
        <div class="popup_btn">
            <button class="cancelBtn" onclick="hidePopup()">å–æ¶ˆå‹ç¼©</button>
        </div>
    </div>
</div>
<!--JSè„šæœ¬-->
<script>

    let passwordErrorCount = 0;
    let currentPath = "NetDisk";
    let pathHistory = [];
    var intervalRunFlag=false;

    document.getElementById('DivAccessLog').style.display = 'none';

    function goBack()
    {
        if (pathHistory.length > 0)
        {
            currentPath = pathHistory.pop();
            loadDir(currentPath);
        }
    }

    ////////////////////è®¿é—®æ—¥å¿—/////////////////////////////////

    fetch('log_access.php')
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));

    ////////////////å¯†ç éªŒè¯//////////////////////////

    function verifyPassword()
    {
        const password = document.getElementById('password').value;
        if (password === 'cleanroom')
        //if (1)
        {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('file-browser').style.display = 'block';
            document.getElementById('DivAccessLog').style.display = 'block';
            loadDir("NetDisk");
        } else
        {
            passwordErrorCount++;
            document.getElementById('error-msg').innerText = 'å¯†ç é”™è¯¯ï¼Œé”™è¯¯æ¬¡æ•°' + passwordErrorCount.toString();
        }

    }

    function handleEnter(event)
    {
        if (event.key === 'Enter')
        {
            verifyPassword();
        }
    }


    //////////////æ ¼å¼åŒ–å¤§å°/////////////////////////////

    function formatSize(bytes)
    {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    ////////////æ ¼å¼åŒ–ä¿®æ”¹æ—¥æœŸ///////////////////////////////

    function formatDate(timestamp)
    {
        return new Date(timestamp * 1000).toLocaleString();
    }

    //////////////åŠ è½½æ–‡ä»¶å¤¹è·¯å¾„///////////////////////

    function loadDir(path = "")
    {
        if (path !== currentPath)
        {
            pathHistory.push(currentPath);
        }
        currentPath = path;


        fetch('filebrowser.php?path=' + encodeURIComponent(path))
            .then(response => response.json())
            .then(data =>
            {
                ///////////////////////////æ·»åŠ ç›®å½•è·¯å¾„//////////////////////////
                let navHtml = '<a href="#" onclick="loadDir("\NetDisk")"></a>';
                let currentPath = '';


                if (path)
                {
                    path.split('/').forEach(dir =>
                    {
                        if (!dir) return;
                        currentPath += (currentPath ? '/' : '') + dir;
                        navHtml += ` / <a href="#" onclick="loadDir('${currentPath}')">${dir}</a>`;
                    });
                }
                document.getElementById('path-nav').innerHTML = navHtml;
                ////////////////////æ–‡ä»¶å¤¹æŒ‰é’®æ·»åŠ /////////////////////////
                let html = '';
                data.dirs.forEach(dir =>
                {
                    const fullPath = path ? `${path}/${dir.name}` : dir.name;
                    html += `<div class="file-item dir">
                           <span class="dir-icon" onclick="loadDir('${fullPath}')">ğŸ“${dir.name}</span>

                            <div class="file-info">
                                æ–‡ä»¶æ•°: ${dir.fileCount} | 
                                å¤§å°: ${formatSize(dir.size)} | 
                                ä¿®æ”¹æ—¥æœŸ: ${formatDate(dir.mtime)}
                            </div>
                       
                            <button onclick="download('${fullPath}', true)">ä¸‹è½½</button>
                        </div>`;
                });

                data.files.forEach(file =>
                {
                    const fullPath = path ? `${path}/${file.name}` : file.name;
                    html += `<div class="file-item file">
                            ğŸ“„ ${file.name}
                            <div class="file-info">
                                å¤§å°: ${formatSize(file.size)} | 
                                ä¿®æ”¹æ—¥æœŸ: ${formatDate(file.mtime)}
                            </div>
                            <button onclick="download('${fullPath}', false)">ä¸‹è½½</button>
                        </div>`;
                });

                document.getElementById('file-list').innerHTML = html || '<div>ç©ºç›®å½•</div>';
            });
    }


    function download(path, isDir)
    {
        //window.location.href = 'download.php?path=' +encodeURIComponent(path) + '&isDir=' + (isDir ? '1' : '0');
        // window.location.href ="download.html";
        if(isDir===true)
        {
		/*
            showPopup();
            // è·å–è¿›åº¦æ¡å…ƒç´ 
            const progressBar = document.getElementById('progressBar');
            const progressValue = document.getElementById('progressValue');
            // åˆå§‹è¿›åº¦å€¼
            let progress = 0;
            let finalProgress=0;

            // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯100æ¯«ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦æ¡
            const intervalId = setInterval(() =>
            {
			
			
			
			 fetch('download.php?compress_progress=1')
                    .then(res => res.json())
                    .then(data => 
					{
                        
									progressValue.innerText="dfaf";

						
						progressValue.innerText=data.progress.toString();
                        
                   
					});
						
	
			    
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§å€¼
                if ((progress >= 1000)||(intervalRunFlag===false))
                {
                    clearInterval(intervalId); // å¦‚æœè¾¾åˆ°100%ï¼Œåœæ­¢å®šæ—¶å™¨
                }
                else
                {
                    // å¢åŠ è¿›åº¦ï¼Œæ¯æ¬¡å¢åŠ 1%
                    progress += 1;
                    finalProgress=progress*0.5;
                    progressBar.value = finalProgress; // æ›´æ–°è¿›åº¦æ¡çš„å€¼
                    var randomNumber = Math.random();
                    randomNumber+=finalProgress;
                    if(randomNumber>99.99)
                    {
                        randomNumber=99.99;
                    }
                    //progressValue.innerText=randomNumber.toFixed(2)+'%';

                }
            }, 500); // 100æ¯«ç§’æ‰§è¡Œä¸€æ¬¡
			
			*/
            window.location.href = 'download.php?path=' +encodeURIComponent(path) + '&isDir=' + (isDir ? '1' : '0');
		   
		   

        }
        else
        {
            window.location.href = 'download.php?path=' +encodeURIComponent(path) + '&isDir=' + (isDir ? '1' : '0');
        }
    }

    ///å¼¹å‡ºæ¡†ç”¨/////////
    function showPopup()
    {
        var overlay = document.getElementById("overlay");
        overlay.style.display = "block";
        intervalRunFlag=true;
    }

    function hidePopup()
    {
        var overlay = document.getElementById("overlay");
        overlay.style.display = "none";
        intervalRunFlag=false;
    }



</script>
</body>
</html>
